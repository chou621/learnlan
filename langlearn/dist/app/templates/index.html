<!DOCTYPE html>
<html>
<head>
    <title>Language Learning</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
        <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f6f9;
        }
        h1 {
            color: #007BFF;
        }
        table {
            margin: auto;
            border-collapse: collapse;
            width: 60%;
        }
        .table-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 750px; /* Set the maximum table height */
            overflow-y: auto; /* Enable vertical scrolling */
            margin: auto;
            width: 100%;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        tr:hover {
            background-color: #f2f2f2;
        }
        a {
            color: #007BFF;
            text-decoration: none;
        }
        .sound-icon {
        cursor: pointer;
        color: #007BFF;
        margin-left: 5px;
        }
        .sound-text {
        cursor: pointer;
        }
        .text-center{
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mt-4 mb-4"><i class="fas fa-book-open"></i> Quiz database</h1>
        <div class="table-container">
            <table class="table">
                <thead>
                    <tr>
                        <th class="align-middle"><i class="fas fa-question-circle"></i> Question (Total {{ quizzes|length }})</th>
                        <th class="align-middle"><i class="fas fa-check"></i> Correct Answer</th>
                        <th class="align-middle"><i class="fas fa-trash"> Actions <i class="fas fa-edit"></i>
                    </tr>
                </thead>
                <tbody>
                    {% for quiz in quizzes %}
                    <tr>
                        <td id="question{{ index_start + loop.index0 }}" class="align-middle"><label class="sound-text" onclick="playAudio('{{ quiz.question }}')">{{ quiz.question }}<i class="fas fa-volume-up sound-icon" ></i></label></td>
                        <td id="answer{{ index_start + loop.index0 }}" class="align-middle">{{ quiz.answer }}</td>
                        <td class="align-middle">
                            <button class="btn btn-danger btn-sm" onclick="confirmDelete('{{ index_start + loop.index0 }}', '{{ quiz.question }}')">Delete</button>
                            <!-- Use Bootstrap Modal component for editing -->
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal{{ index_start + loop.index0 }}">Edit</button>
                        </td>
                    </tr>
                        <!-- Edit Modal -->
                        <div class="modal" id="editModal{{ index_start + loop.index0 }}" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true" onshow="onEditModalShow('{{ index_start + loop.index0 }}')">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                 <div class="modal-header">
                                    <h5 class="modal-title" id="editModalLabel">Edit Question</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <!-- Edit Form -->
                                    <form id="editForm{{ index_start + loop.index0 }}">
                                        <div class="form-group">
                                            <label for="language">Language:</label>
                                            <select class="form-control" id="editLanguage{{ index_start + loop.index0 }}" name="language" data-index="{{ index_start + loop.index0 }}" disabled>                                                
                                                <option value="af" {% if quiz.language == "af" %} selected {% endif %}>Afrikaans</option>
                                                <option value="ar" {% if quiz.language == "ar" %} selected {% endif %}>Arabic</option>
                                                <option value="af" {% if quiz.language == "af" %} selected {% endif %}>Afrikaans</option>
                                                <option value="ar" {% if quiz.language == "ar" %} selected {% endif %}>Arabic</option>
                                                <option value="zh-CN" {% if quiz.language == "zh-CN" %} selected {% endif %}>Chinese (China)</option>
                                                <option value="zh-TW" {% if quiz.language == "zh-TW" %} selected {% endif %}>Chinese (Taiwan)</option>
                                                <option value="en-US" {% if quiz.language == "en-US" %} selected {% endif %}>English (United States)</option>
                                                <option value="fr-FR" {% if quiz.language == "fr-FR" %} selected {% endif %}>French (France)</option>
                                                <option value="de" {% if quiz.language == "de" %} selected {% endif %}>German (Germany)</option>
                                                <option value="hi" {% if quiz.language == "hi" %} selected {% endif %}>Hindi (India)</option>
                                                <option value="id" {% if quiz.language == "id" %} selected {% endif %}>Indonesian</option>
                                                <option value="it" {% if quiz.language == "it" %} selected {% endif %}>Italian (Italy)</option>
                                                <option value="ja" {% if quiz.language == "ja" %} selected {% endif %}>Japanese (Japan)</option>
                                                <option value="ko" {% if quiz.language == "ko" %} selected {% endif %}>Korean (Korea)</option>
                                                <option value="ms" {% if quiz.language == "ms" %} selected {% endif %}>Malaysian</option>
                                                <option value="pl" {% if quiz.language == "pl" %} selected {% endif %}>Polish</option>
                                                <option value="pt-BR" {% if quiz.language == "pt-BR" %} selected {% endif %}>Portuguese (Brazil)</option>
                                                <option value="ru" {% if quiz.language == "ru" %} selected {% endif %}>Russian (Russia)</option>
                                                <option value="sv" {% if quiz.language == "sv" %} selected {% endif %}>Swedish</option>
                                                <option value="th" {% if quiz.language == "th" %} selected {% endif %}>Thai (Thailand)</option>
                                                <option value="tr" {% if quiz.language == "tr" %} selected {% endif %}>Turkish</option>
                                                <option value="uk" {% if quiz.language == "uk" %} selected {% endif %}>Ukrainian</option>
                                                <option value="vi" {% if quiz.language == "vi" %} selected {% endif %}>Vietnamese</option>
                                                <option value="es-ES" {% if quiz.language == "es-ES" %} selected {% endif %}>Spanish (Spain)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="questionInput{{ index_start + loop.index0 }}">Question</label>
                                            <input type="text" class="form-control" id="questionInput{{ index_start + loop.index0 }}" value="{{ quiz.question }}" oninput="onQuestionInputChange('{{ index_start + loop.index0 }}')">
                                            <div id="message{{ index_start + loop.index0 }}" style="color: red;"></div>
                                        </div>
                                        <div class="form-group">
                                            <label for="answerInput{{ index_start + loop.index0 }}">Correct Answer</label>
                                            <input type="text" class="form-control" id="answerInput{{ index_start + loop.index0 }}" value="{{ quiz.answer }}">
                                        </div>
                                    </form>                                
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="saveEdit('{{ index_start + loop.index0 }}')">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        <div class="text-center">
            <a class="btn btn-primary" href="/add">Add Question</a>
            <button class="btn btn-danger" onclick="confirmDeleteAll()">Delete All Questions</button>        
            <input type="number" id="numOfQuestionsInput" placeholder="Number of Quizzes" min="1" max="{{ quizzes|length }}" value="10" style="width: 160px; display: inline-block; text-align: center;">
            <a class="btn btn-success" href="#" onclick="startQuiz()"><i class="fas fa-play"></i> Start Quiz</a>
            <div id="inputError" style="color: red;"></div>
        </div>
    </div>

<script>
quizzes_count = {{ quizzes|length }};

window.addEventListener("load", function () {
    const startQuizButton = document.querySelector(".btn-success");
    const numOfQuestionsInput = document.getElementById("numOfQuestionsInput");

    // 檢查是否有資料，決定是否顯示開始測驗按鈕
    if (quizzes_count === 0) {
        startQuizButton.style.display = "none";
        numOfQuestionsInput.style.display = "none";
    }
    else if (quizzes_count < 10){
        numOfQuestionsInput.value=quizzes_count;
    }
});

    function choosequizzes() {
    var x = document.getElementById("numOfQuestionsInput").placeholder;
}

        function startQuiz() {
            const numOfQuestionsInput = document.getElementById("numOfQuestionsInput").value;
            if (!numOfQuestionsInput || isNaN(numOfQuestionsInput) || parseInt(numOfQuestionsInput) <= 0) {
            const inputErrorElement = document.getElementById("inputError");
            inputErrorElement.textContent = "Please enter a valid number";
        return;
        }


            window.location.href = `/quiz?numOfQuestions=${numOfQuestionsInput}`;
        }
        
function confirmDelete(index, question) {
    if (confirm("Are you sure you want to delete this question?")) {
        fetch("/delete/" + index, {
            method: "DELETE",
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Deletion successful!");
                location.reload(); // 刷新頁面以更新表格
            } else {
                alert("Deletion failed, please try again later.");
            }
        })
        .catch(error => {
            alert("Deletion failed, please try again later.");
            console.error("Error:", error);
        });
    }
}
</script>
<script>
function confirmDeleteAll() {
    if (confirm("Are you sure you want to delete all questions?")) {
        fetch("/delete_all", {
            method: "DELETE",
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Deletion of all questions successful!");
                location.reload();
            } else {
                alert("Deletion of all questions failed, please try again later.");
            }
        })
        .catch(error => {
            alert("Deletion of all questions failed, please try again later.");
            console.error("Error:", error);
        });
    }
}
</script>

<script>
    /* ... 略 ... */
  
    // 新增一個保存編輯結果的函式
    function saveEdit(index) {
  // 取得編輯表單的資料
  const selectedLanguage = document.getElementById(`editLanguage${index}`).value;
  const questionInput = document.getElementById("questionInput" + index).value;
  const answerInput = document.getElementById("answerInput" + index).value;

  // 建立更新的資料物件
  const updatedQuiz = {
    "language": selectedLanguage,
    "question": questionInput,
    "answer": answerInput
  };

  // 發送更新請求到後端
  fetch("/update/" + index, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify(updatedQuiz)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
        alert("Update successful!");
                location.reload();
            } else {
                alert("Update failed, please try again later.");
            }
        })
        .catch(error => {
            alert("Update failed, please try again later.");
    console.error("Error:", error);
  });

  // 關閉Modal
  const editModal = new bootstrap.Modal(document.getElementById("editModal" + index));
  editModal.hide();
}
  </script>
<script>
    // 使用 fetch 函式向伺服器端發送檢查題目是否已存在的請求
    function checkDuplicateQuestion(question, index) {
        return fetch(`/check_duplicate/${encodeURIComponent(question)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const messageElement = document.getElementById(`message${index}`);
                const questionInput = document.getElementById(`questionInput${index}`);
                const originalQuestion = questionInput.getAttribute("data-original");
                const trimmedQuestion = question.trim();

                if (data.exists && trimmedQuestion !== originalQuestion) {
                    messageElement.textContent = "The same question already exists.";
                } else {
                    messageElement.textContent = "";
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // 監聽題目輸入框的變化
    function onQuestionInputChange(index) {
        const questionInput = document.getElementById(`questionInput${index}`);
        const question = questionInput.value;

        // 如果題目為空或少於兩個字元，不進行檢查
        if (question === "" || question.length < 2) {
            return;
        }

        // 檢查題目是否已存在
        checkDuplicateQuestion(question, index);
    }

    // 編輯 Modal 顯示事件處理函式
    function onEditModalShow(index) {
        const questionInput = document.getElementById(`questionInput${index}`);
        questionInput.setAttribute("data-original", questionInput.value);
    }

    // 取消編輯 Modal 事件處理函式
    function onCancelEdit(index) {
        const questionInput = document.getElementById(`questionInput${index}`);
        const originalQuestion = questionInput.getAttribute("data-original");
        questionInput.value = originalQuestion;

        // 清空提示訊息
        const messageElement = document.getElementById(`message${index}`);
        messageElement.textContent = "";
    }
    function playAudio(question) {
        // 使用 fetch 函式向伺服器端發送播放音檔的請求
        fetch(`/play_audio/${encodeURIComponent(question)}`)
            .then(response => {
                if (response.ok) {
                    const audio = new Audio(response.url);
                    audio.play();
                } else {
                    throw new Error('Network response was not ok');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
</script>
  </body>
</html>
